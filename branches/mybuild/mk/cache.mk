
ifndef CACHE_INCLUDES
$(error CACHE_INCLUDES is not defined)
endif

ifeq ($(findstring --no-print-directory,$(MAKEFLAGS)),)
$(error '--no-print-directory' flag must be specified)
endif

include mk/core/common.mk

.PHONY : all
all : header body
header:
	@echo '# Generated by GNU Make $(MAKE_VERSION) on $(__cache_timestamp).'
	@echo ''
	@$(call __cache_echo_list_comment,CACHE_USES)
	@$(call __cache_echo_list_comment,CACHE_INCLUDES)
	@$(call __cache_echo_list_comment,MAKEFILE_LIST)
	@echo ''
	@echo 'include mk/core/common.mk'
	@echo ''
body:
	@$(__cache_print_all_new_variable_definitions)#

__cache_timestamp := $(shell date)
__cache_echo_list_comment = \
	echo '$(\h) $1:'; \
	$(or $(foreach mk,$($1),echo '$(\h)   $(mk)';),echo '$(\h)   <nothing>';)

# No args.
__cache_print_all_new_variable_definitions = \
	$(and $(foreach 1,$(call __cache_sort,$(filter-out \
			$(__cache_preinclude_variables), \
			$(__cache_postinclude_variables))), \
		$(info $(__cache_construct_variable_definition))),)

# Arg 1: list of variables.
__cache_sort = \
	$(foreach v, \
		$(sort $(join $(patsubst [%],%_,$(subst _,,$(1:%=[%]))),$1)),$ \
		$(subst [$v]$(firstword $(subst _,_ ,$v)),,[$v]$v))

# __cache_construct_xxx
# Arg 1: variable name.
__cache_construct_variable_definition = \
	$(__cache_construct_$(if \
		$(findstring $(\h),$(subst $(\n),$(\h),$(value $1))) \
			,verbose,regular)_$(flavor $1)_variable)

__cache_construct_regular_simple_variable = \
	$(__cache_escape_variable_name) := \
		$(if $(__cache_variable_has_leading_ws),$$(\0))$(subst $$,$$$$,$(value $1))

__cache_construct_regular_recursive_variable = \
	$(if $(__cache_variable_has_leading_ws),$ \
		$(__cache_construct_verbose_recursive_variable),$ \
		$(__cache_escape_variable_name) = $(value $1))

__cache_construct_verbose_recursive_variable = \
	define $(__cache_escape_variable_name)$(\n)$ \
		$(value $1)$(\n)$ \
	endef
__cache_construct_verbose_simple_variable = \
	$(__cache_construct_verbose_recursive_variable)$(\n)$ \
	$(__cache_escape_variable_name) := $$(value $(__cache_escape_variable_name))

__cache_construct_regular_undefined_variable = $(__cache_error_undefined)
__cache_construct_verbose_undefined_variable = $(__cache_error_undefined)

__cache_error_undefined = \
	$(error Undefined variable '$1' listed in '.VARIABLES')

__cache_escape_variable_name = \
	$(subst $(=),$$(=),$(subst $(:),$$(:),$(subst $(\h),$$(\h),$(subst $$,$$$$,$1))))
__cache_variable_has_leading_ws = \
	$(subst x$(firstword $(value $1)),,$(firstword x$(value $1)))

__cache_preinclude_variables :=
__cache_postinclude_variables :=

# Include scripts which should not be cached...
include $(CACHE_USES)

# Collect variables...
__cache_preinclude_variables := $(.VARIABLES)
include $(CACHE_INCLUDES)
__cache_postinclude_variables := $(.VARIABLES)

