#summary Testing framework

== Тесты ==
В сборку системы входит набор тестов для диагностики. 

Тесты могут выполняться как в автоматическом режиме, при старте системы (самодиагностика системы), так и в ручном режиме пользователем. При вызове в автоматическом режиме тесты выдают соответствующие информационные сообщения. При работе в ручном режиме используется команда expresstest. С ее помощью можно как получить информацию о доступных тестах в системе, результатах их выполнения, так и запустить требуемый тест на исполнение.

Состав тестов и их параметры, как и другие части системы, можно конфигурировать, не изменяя исходных кодов самих тестов. Процесс добавления в систему нового теста и его конфигурации описан ниже.

== Добавление теста ==
Исходные коды тестов находятся в папках `src/tests/` и `platform/<platform>/tests/`. Для добавления нового теста в систему в одной из этих папок нужно создать свою папку с тестом (см. шаблон `src/tests/_test_template`). В ней обязательно должны быть как минимум 2 файла следующего содержания:

 * Файл с исходным кодом теста
 * makefile для сборки этого теста в системе

=== Требования к исходному коду теста ===
Тесты представлены в системе как модули пакета `embox.test` или `<platform>.test` . Для того что бы система могла распознать тест, его нужно определить следующим образом:

 * Реализовать функцию выполнения теста.
 * Объявить тест в системе с помощью соответствующего макроса.

==== Функция выполнения ====
Каждый тест должен иметь функцию выполнения, которая запускается системой при вызове данного теста, со следующей сигнатурой:
{{{
int run(void);
}}}
Функция возвращает 0 в случае прохождения теста и любое другое значение, если тест не пройден. Если для теста задана функция подробного описания, то это значение будут передано ей в качестве аргумента.

==== Функция подробного описания ====
Каждый тест может иметь функцию подробного описания, определить ее нужно следующим образом:
{{{
void (*info)(int);
}}}
Эта функция вызывается по требованию пользователя в случае провала теста и должна напечатать причину неудачи. В качестве аргумента передается последнее ненулевое значение, возвращенное функцией выполнения теста.

==== Макросы для объявления тестов ====
Для объявления теста в системе необходимо указать некоторую информацию, в первую очередь, функция выполнения теста. Это делается с помощью следующих макросов объявленных в файле <embox/test.h>:

 * `EMBOX_TEST(run);` - объявляет тест в системе. В качестве имени теста по умолчанию используется имя модуля, описанного в makefile'е.
 * `EMBOX_TEST_DETAILS(run, "name", info);` - позволяет задать для теста произвольное имя и функцию детальной информации.


==== Макросы для экспортирования и импортирования тестов ====
Экспорт и импорт тестов нужен, когда из одного теста хочется вызвать другой, не прибегая к стандартному вызову тестов через фреймворк. Для этого применяются макросы:
 * `EMBOX_TEST_EXPORT(<symbol_name>);`
 * `EMBOX_TEST_IMPORT(<symbol_name>);`

В вызываемом тесте указываем макрос EMBOX_TEST_EXPORT, в вызывающем - EMBOX_TEST_IMPORT, с одинаковыми аргументами. Тест вызывается по имени, заданному в аргументе.

==== Пример кода минимального теста ====
{{{
#include <embox/test.h>

EMBOX_TEST(run);

static int run(void) {
	int result = 0;

	/*
	 * The test itself.
	 */

	return result;
}
}}}

=== Требования к  содержимому makefile ===
 * Makefile должен быть описан так:
{{{
$_MODS += <test_name>

$_SRCS-<test_name> += *.c
}}}

В Makefile могут быть описаны зависимости от других модулей системы, например

{{{
$_DEPS-<test_name> += <dep>
}}}

= Конфигурирование теста =
Необходимо добавить в файл конфигурации `mods-tests.conf` запись о новом тесте:

{{{
test(<test_name>, <runlevel>)
}}}
или
{{{
test_platform(<test_name>, <runlevel>)
}}}
для тестов платформо-зависимых частей системы.
Где:

 * `<test_name>` - имя модуля теста, заданное в makefile'е.
 * `<runlevel>` - (необязательно) уровень выполнения системы, на котором следует запускать тест

Любой тест можно запустить вручную командой expresstest.