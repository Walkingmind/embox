#summary Describes some simulators where Embox can be run

<wiki:toc max_depth="3" />

= SPARC = 

== TSIM ==

 # Install [ftp://ftp.gaisler.com/gaisler.com/tsim/tsim-eval-2.0.18.tar.gz tsim-eval]
 # tsim-leon3 -fast_uart -gdb
 # Connect to gdb server

= x86 =

== QEMU ==

Install [http://wiki.qemu.org/Download QEMU]

=== Installing GRUB on Qemu usable virtual hard disk ===

 # Create a disk image (21 MB)
{{{
dd if=/dev/zero of=hd0.img count=40320
}}}
 # Create a partition on the disk image
{{{
/sbin/fdisk hd0.img
}}}
  # Setup geometry:
   * x - extra functionality
   * h 16
   * s 63
   * c 40
   * r - return to main menu
  # n, p, 1, enter, enter - create new partition
  # a 1 - make bootable
  # w - write the table to disk
 # Setup the loopback device (1048576 = 2048 x 512 bytes)
{{{
/sbin/fdisk -u -l hd0.img
sudo /sbin/losetup -o 1048576 /dev/loop0 hd0.img 

may be instead of 1048576 need enter 512*(start partiton from output above /sbin/fdisk)
}}}

 # Create a file system
{{{
sudo /sbin/mkfs.ext2 /dev/loop0
}}}
 # Mount the image
{{{
sudo mount /dev/loop0 /mnt/flash
}}}
 # Build GRUB
  # Download [ftp://alpha.gnu.org/gnu/grub/grub-0.97.tar.gz grub-0.97.tar.gz]
  # tar -xzf grub-0.97.tar.gz
  # cd grub-0.97 && ./configure && make && cd ..
 # Install GRUB (stage1 and stage2)
{{{
sudo mkdir -p /mnt/flash/boot/grub
sudo cp grub-0.97/stage1/stage1 grub-0.97/stage2/stage2 /mnt/flash/boot/grub
}}}
 # Put Embox image
{{{
cp path/embox /mnt/flash
}}}
 # Unmount the disk image
{{{
sudo umount /mnt/flash
}}}
 # Detach the loopback device
{{{
sudo /sbin/losetup -d /dev/loop0
}}}
 # Setup GRUB device map
{{{
grub-0.97/grub/grub --device-map=/dev/null
    > device (hd0) hd0.img
    > geometry (hd0) 40 16 63
    > root (hd0,0)
    > setup (hd0)
    > quit
}}}
 # Boot using Qemu with GRUB
{{{
qemu -hda hd0.img
}}}
 # Boot Embox using GRUB
  # during loading process press 'c' to enter grub console, if necessary
  # discover path where was Embox image placed with command "ls"
  # load the image by the command
   * {{{"kernel <path>"}}} for grub (0.9x)
   * {{{"multiboot <path>"}}} for grub2 (1.98)
{{{
    grub> kernel /boot/embox
}}}
  # start Embox by the command "boot"
{{{
    grub> boot
}}}

=== Networking with QEMU via TAP interface ===

{{{
/sbin/ifconfig eth0 down
/sbin/ifconfig eth0 0.0.0.0 promisc up
/usr/sbin/openvpn --mktun --dev tap0 --user `id -un`
/sbin/ifconfig tap0 0.0.0.0 promisc up
/usr/sbin/brctl addbr br0
/usr/sbin/brctl addif br0 eth0
/usr/sbin/brctl addif br0 tap0
/usr/sbin/brctl stp br0 off
/sbin/ifconfig br0 10.0.2.3 netmask 255.0.0.0 broadcast 10.255.255.255
/sbin/route add default gw 10.0.2.2
qemu -m 256 -hda hd0.img -net nic,model=ne2k_pci -net tap,ifname=tap0,script=no
/sbin/ifconfig eth0 down
/sbin/ifconfig br0 down
/usr/sbin/brctl delbr br0
/sbin/ifconfig eth0 -promisc
/sbin/ifconfig eth0 up
/usr/sbin/openvpn --rmtun --dev tap0
}}}

=== Networking with QEMU via socket ===

 # Download [http://wiki.qemu.org/download/linux-0.2.img.bz2 small linux disk image]
 # Run linux with
{{{
qemu -hda linux-0.2.img -net nic,model=ne2k_pci,macaddr=AA:BB:CC:DD:EE:01 -net socket,listen=:1234
}}}
 # Run Embox with
{{{
qemu -kernel build/base/bin/embox -net nic,model=ne2k_pci,macaddr=AA:BB:CC:DD:EE:02 -net socket,connect=127.0.0.1:1234
}}}
 # Any frames transmitted by Linux is received by Embox, and vice versa

=== Remote Debugging ===

 # Start qemu with the -s -S
{{{
qemu -s -S -kernel path/embox
}}}
 # Start GDB (.gdbinit is available in embox root dir, so just type gdb)
{{{
gdb path/embox
.
.
(gdb) target remote :1234
(gdb) c
}}}

=== Non VGA console ===

Use serial console output with:
{{{
qemu -nographic -vga none ...
}}}
Ctrl-A+x for exit.

== Bochs ==

 # Create hd0.img (as stated above)
 # bochs.cfg
{{{
megs: 32
cpu: count=1, ips=15000000
romimage: file=/usr/share/bochs/BIOS-bochs-latest, address=0xe0000
vgaromimage: /usr/share/bochs/VGABIOS-elpin-2.40
vga: extension=vbe
ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
ata0-master: type=disk, path=hd0.img, mode=flat, cylinders=40, heads=16, spt=63, translation=none
boot: disk
log: bochsout.txt
mouse: enabled=0
clock: sync=realtime
#gdbstub: enabled=1, port=1234, text_base=0, data_base=0, bss_base=0
#ne2k: ioaddr=0x300, irq=9, mac=AA:BB:CC:DD:EE:00, ethmod=linux, ethdev=eth0
}}}
 # bochs -f bochs.cfg

NOTE: there is a problem with booting Embox from grub, need for fix.

= ARM =

== SKYEYE == 

Targeted to ARM simulation (and maybe LEON2). Used for Atmel AT91 simulation as that installed in Lego NXT brick. Have UART support.

Install Skyeye:
   
   [http://sourceforge.net/projects/skyeye/files/skyeye/skyeye-1.3.0_rc1.tar.gz/download skyeye-1.3.0rc1]

   [http://sourceforge.net/projects/skyeye/files/skyeye/skyeye-1.2.6_rc1/skyeye-1.2.6_rc1.tar.bz2/download skyeye-1.2.6rc1] (recommended)

 # Using skyeye.conf
{{{
arch:arm
cpu: arm7tdmi

mach: at91

mem_bank: map=M, type=RW,  addr=0x00000000,  size=0x10000000
mem_bank: map=I, type=RW,  addr=0xf0000000,  size=0x10000000
uart:mod=term
}}}
 # Start simulator
{{{
skyeye -d -c [path-to-embox]/third-party/conf/skyeye.conf
}}}
 # Load Embox into skyeye
{{{
arm-elf-gdb [path-to-embox-elf]
    (gdb) tar extended-remote :12345
    (gdb) load
}}}
 # Now we can debug, e.g. just run 
{{{
    (gdb) c
}}}
